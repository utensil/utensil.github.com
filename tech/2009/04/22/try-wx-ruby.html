<!DOCTYPE html> <html> <head> <meta charset=utf-8> <meta content='IE=edge,chrome=1' http-equiv=X-UA-Compatible> <!--[if (lt IE 9)&(!IEMobile)]><script src="/javascripts/html5.js?1561800219"></script><![endif]--> <meta content='width=device-width, initial-scale=1.0' name=viewport> <title>wxRuby尝鲜</title> <link href="/stylesheets/site.css?1561800219" rel=stylesheet /> <link href="/stylesheets/blog.css?1561800219" rel=stylesheet /> <link href="/stylesheets/highlight/railscasts.css?1561800219" rel=stylesheet /> <!--[if lt IE 9]><script src="/javascripts/respond.js?1561800219"></script><![endif]--> </head> <body class=''> <div id=container> <div id=main role=main> <aside class=sidebar> <nav> <span> <a href='/tech/'>home</a> </span> <span> <a href='/tech/calendar.html'>calendar</a> </span> <span> <a href='/tech/tags.html'>tags</a> </span> </nav> </aside> <div class=content> <header> <div class=article_nav> <span class=later> <a href='/tech/2009/05/01/linux-kernel-notes-process-1.html'> < 更新 </a> </span> <span class=earlier> <a href='/tech/2009/04/21/ofstream-and-ate.html'> 更早 > </a> </span> </div> <h1> wxRuby尝鲜 </h1> </header> <article class=markdown-body> <p>wxRuby最好玩的地方是它对wxWidgets多加了一层糖衣的语法。</p> <p>安装了</p> <pre><code>gem install wxruby
</code></pre> <p>之后，还要安装</p> <pre><code>gem install wx_sugar
</code></pre> <p>这样子，我们不仅具有了一些<code>:param_name =&gt; value</code>这样的糖衣，可以使用<code>attr_*</code>族来暴露实例变量，还有了用<code>do...end</code>块来做layout和菜单的能力，比较爽的一点还有用block来处理事件。</p> <p>简单讲解一下怎么使用<code>:param_name =&gt; value</code>这样的糖衣：比如wxRuby中某函数<code>f(a,b)</code>，有了wx_sugar之后，就可以写<code>f(:a=&gt;5, :b=&gt;&#39;string&#39;)</code>来调用。</p> <p>下面这个小程序使用了wxAUI和wxStyledTextCtrl。用途是在非常长的文本文件中，同时搜索多个关键字，建立索引，包含上下文和定位的链接。</p> <p>multi_searcher.rb</p> <pre><code class="ruby">require &#39;rubygems&#39;  
require &#39;wx&#39;  
require &#39;wx_sugar/all&#39;  
require &#39;erb&#39;  
require &#39;ya2yaml&#39;  

include Wx  

$KCODE = &#39;utf8&#39;  

def min(a, b)  
    a &gt;= b ? b : a  
end  

def max(a, b)  
    a &gt;= b ? a : b  
end  

class KeywordsPane &lt; Panel  
    def initialize(parent, options = {})  
        super(parent, options.merge!(:size =&gt; [500, 500]))  
        arrange_vertically do  
            add @keyword = TextCtrl.new(self, :style =&gt; Wx::TE_MULTILINE, :size =&gt; [-1, 200]), :proportion =&gt; 1              

            arrange_horizontally do  
                add @status = StaticText.new(self, :label =&gt; &#39;&#39;, :size =&gt; [150, -1]), :proportion =&gt; 1  
                add Button.new(self, :label =&gt; &#39;查找&#39;) do |button|  
                    evt_button(button) do |event|  
                        #search  
                        get_parent.filecontent_pane.search(@keyword.get_value)  
                    end                   
                end               
            end  
        end       
    end  

    attr_reader :keyword, :status  
end  

class ReportPane &lt; Panel   
    def initialize(parent, options = {})  
        super(parent, options.merge!(:size =&gt; [500, 500]))  
        arrange_vertically do  
            add @report = HtmlWindow.new(self), :proportion =&gt; 1 do |report|  
                evt_html_link_clicked(report) do | event |  
                    position = event.get_link_info.get_href.sub(/position\:\/\//, &#39;&#39;).split(&#39;,&#39;)  
                    get_parent.filecontent_pane.file.set_selection position[0].to_i, position[1].to_i  
                end  
            end  
            add Button.new(self, :label =&gt; &#39;保存报告&#39;) do |button|  
                evt_button(button) do |event|  
                    ask4file = FileDialog.new(self, :style =&gt; FD_SAVE, :message =&gt; &#39;保存报告&#39;, :wildcard =&gt; &#39;HTML files(*.html)|*.html&#39;)  
                    File.new(ask4file.get_path, &#39;w&#39;).write @report_text if ask4file.show_modal == Wx::ID_OK  
                end  
            end  
        end  

    end  

    attr_reader :report  
    attr_writer :report_text  
end  

class FilecontentPane &lt; Panel   
    def initialize(parent, options = {})  
        super(parent, options.merge!(:size =&gt; [500, 500]))  

        arrange_vertically do  
            add Button.new(self, :label =&gt; &#39;打开要查找的文件&#39;) do |button|  
                evt_button(button) do |event|  
                    #open file  
                    ask4file = FileDialog.new(self, :message =&gt; &#39;打开要查找的文件&#39;)  
                    @file.load_file(ask4file.get_path) if ask4file.show_modal == Wx::ID_OK  
                    # auto adapt to the width of max line count  
                    @file.set_margin_width 0, @file.text_width(33, &quot;__#{@file.get_line_count}&quot;)   
                end  
            end  
            add @file = StyledTextCtrl.new(self), :proportion =&gt; 1  
            @file.set_margin_width 0, @file.text_width(33, &#39;999&#39;) # show line number  
            add StaticText.new(self, :label =&gt; &#39;小提示：按住Ctrl+鼠标滚轮可以缩放文字大小&#39;)  
        end  
    end  

    def search(keywords)  
        keywords_a = keywords.split(&#39;, &#39;)  
        @search_result = {}  
        file_length = @file.get_text_length  

        beg_pos = 0       

        keywords_a.each do |k|  
            @search_result[k] = []  

            @file.goto_pos 0  
            @file.search_anchor  

            while((beg_pos = @file.search_next(0,k)) != -1)               

                end_pos = beg_pos + k.length  

                context = @file.get_text_range max(beg_pos - 520, 0), min(end_pos + 520, file_length)  

                context.gsub! k, &#39;&lt;font size=7&gt;&lt;b&gt;&lt;u&gt;\0&lt;/u&gt;&lt;/b&gt;&lt;/font&gt;&#39;   
                # coord = [@file.line_from_position(beg_pos), @file.get_column(beg_pos)]  
                @search_result[k] &lt;&lt; { :context =&gt; context, :position =&gt; [beg_pos, end_pos], :coord =&gt; [@file.line_from_position(beg_pos), @file.get_column(beg_pos)]}  

                get_parent.keywords_pane.status.set_label &quot;正在搜索#{k}...完成%3.2f%% ...&quot; % (beg_pos * 100.0 / file_length)    

                @file.goto_pos end_pos + 1  
                @file.search_anchor  
            end  
        end  
        get_parent.keywords_pane.status.set_label &#39;搜索完成，正在生成报告...&#39;  
        get_parent.report_pane.report.set_page report_text = ERB.new(File.read(&#39;report.html.erb&#39;), 0, &quot;%&lt;&gt;&quot;).result(binding)  

        get_parent.keywords_pane.status.set_label &#39;&#39;  
        get_parent.report_pane.report_text = report_text  
    end   

    attr_reader :file  
end  

class MyFrame &lt; Frame  
   def initialize(title)  
        super(nil, :title =&gt; title, :size =&gt; [800, 600])  
        @mgr = AuiManager.new  
        @mgr.set_managed_window(self)  

        pi = AuiPaneInfo.new  
        pi.set_name(&#39;keywords_pane&#39;).set_caption(&#39;在下面键入关键字，每个关键字之间用 一个逗号一个空格 隔开（例如keyword1, keyword2）：&#39;)  
        pi.top.set_maximize_button.set_close_button(false)        
        @mgr.add_pane(@keywords_pane = KeywordsPane.new(self), pi)  

        pi = AuiPaneInfo.new  
        pi.set_name(&#39;report_pane&#39;).set_caption(&#39;查找结果报告&#39;)  
        pi.left.set_maximize_button.set_close_button(false)       
        @mgr.add_pane(@report_pane = ReportPane.new(self), pi)  

        pi = AuiPaneInfo.new  
        pi.set_name(&#39;filecontent_pane&#39;).set_caption(&#39;被查找文件&#39;)  
        pi.center.set_maximize_button.set_close_button(false)  
        @mgr.add_pane(@filecontent_pane = FilecontentPane.new(self), pi)      

        @mgr.update  
   end  

   attr_reader :keywords_pane, :report_pane, :filecontent_pane  
end  


class MyApp &lt; App  
   def on_init  
     frame = MyFrame.new(&#39;多关键字搜索助手&#39;)  
     frame.show  
   end  
end  

a = MyApp.new  
a.main_loop  
</code></pre> <p>程序中使用的erb模板report.html.erb:</p> <pre><code class="html">&lt;html&gt;  
&lt;body&gt;  
&lt;% @search_result.each do |keyword, info| %&gt;  
&lt;dt&gt;&lt;%= keyword %&gt;(找到&lt;%= info.length %&gt;处)&lt;/dt&gt;  
&lt;dd&gt;  
&lt;% unless info.empty? %&gt;  
    &lt;table border=1&gt;  
        &lt;tr&gt;  
            &lt;th&gt;位置&lt;/th&gt;  
            &lt;th&gt;上下文&lt;/th&gt;  
        &lt;/tr&gt;  
        &lt;% info.each do |v|%&gt;  
            &lt;tr&gt;  
                &lt;td&gt;&lt;a href=&#39;position://&lt;%= v[:position].join &#39;,&#39; %&gt;&#39;&gt;&lt;%= &quot;#{v[:coord][0]}行#{v[:coord][1]}列&quot; %&gt;&lt;/a&gt;&lt;/td&gt;  
                &lt;td&gt;&lt;pre&gt;&lt;%= v[:context] %&gt;&lt;/pre&gt;&lt;/td&gt;  
            &lt;/tr&gt;  
        &lt;% end %&gt;  
    &lt;/table&gt;  
&lt;% end %&gt;  
&lt;/dd&gt;  
&lt;% end %&gt;  
&lt;/body&gt;  
&lt;/html&gt;
</code></pre> <section class=meta> <p> <span class=author> <a href='/'>宋皿</a> </span> <span class=time> <time datetime='2009-04-22 00:00:00 +0800'> 2009-04-22 </time> </span> </p> <p> <span class=license> Published under <a href='http://creativecommons.org/licenses/by-nc-nd/3.0/' rel=license>(CC) BY-NC-ND</a> </span> <span class=tags> tagged with <a href='/tech/tags.html#tag-wx'> wx </a> <a href='/tech/tags.html#tag-ruby'> ruby </a> </span> </p> </section> <div id=disqus_thread></div> <script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'utensil-at-github'; // required: replace example with your forum shortname
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script> <a class=dsq-brlink href='http://disqus.com'> comments powered by <span class=logo-disqus>Disqus</span> </a> </article> </div> </div> </div> <script src="/javascripts/jquery-1.7.1.js?1561800219"></script> <script src="/javascripts/highlight.pack.js?1561800219"></script> <script>
  hljs.initHighlightingOnLoad();
  // $(document).ready(function() {
  //   $('pre code').each(function(i, e) {hljs.highlightBlock(e)});
  // });
</script> <script>
  // (function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"===e.location.protocol?"https:":"http:")+'//cdn.mxpnl.com/libs/mixpanel-2.2.min.js';f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f);b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!== typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");for(g=0;g<i.length;g++)f(c,i[g]); b._i.push([a,e,d])};b.__SV=1.2}})(document,window.mixpanel||[]); mixpanel.init("eda89891866a7e90b6699df21e79ea61");
  // mixpanel.track("visit");
</script> </body> </html>