<!DOCTYPE html> <html> <head> <meta charset=utf-8> <meta content='IE=edge,chrome=1' http-equiv=X-UA-Compatible> <!--[if (lt IE 9)&(!IEMobile)]><script src="/javascripts/html5.js?1593163993"></script><![endif]--> <meta content='width=device-width, initial-scale=1.0' name=viewport> <title>如何进行证书、私钥相关的各种操作</title> <link href="/stylesheets/site.css?1593163993" rel=stylesheet /> <link href="/stylesheets/blog.css?1593163993" rel=stylesheet /> <link href="/stylesheets/highlight/railscasts.css?1593163993" rel=stylesheet /> <!--[if lt IE 9]><script src="/javascripts/respond.js?1593163993"></script><![endif]--> </head> <body class=''> <div id=container> <div id=main role=main> <aside class=sidebar> <nav> <span> <a href='/tech/'>home</a> </span> <span> <a href='/tech/calendar.html'>calendar</a> </span> <span> <a href='/tech/tags.html'>tags</a> </span> </nav> </aside> <div class=content> <header> <div class=article_nav> <span class=later> <a href='/tech/2011/08/26/ruby-script-draw-svn-graph.html'> < 更新 </a> </span> <span class=earlier> <a href='/tech/2011/05/30/first-commercial-quantum-computer.html'> 更早 > </a> </span> </div> <h1> 如何进行证书、私钥相关的各种操作 </h1> </header> <article class=markdown-body> <h3>需求1：生成公私钥对和证书(pem格式或der格式)</h3> <p>生成公私钥对和证书请求</p> <pre><code>openssl req -newkey rsa:1024 -sha1 -pubkey -config myopenssl.cnf -keyout root.pri.key.pem -out root.cer.req.pem -days 3650  &gt; root.pub.key.pem
</code></pre> <p>根据公私钥对和证书请求生成pem格式的证书</p> <pre><code>openssl x509 -req -in root.cer.req.pem -sha1 -extfile myopenssl.cnf -extensions v3_ca -signkey root.pri.key.pem -out root.cer.pem -days 3650
</code></pre> <p>以上得到的产物包括：</p> <ul> <li>私钥文件：root.pri.key.pem</li> <li>公钥文件：root.pub.key.pem</li> <li>pem格式证书：root.cer.pem</li> </ul> <h3>需求2：生成pfx(基于需求1)</h3> <p>将私钥和公钥合并</p> <pre><code>cat root.cer.pem root.pri.key.pem &gt; root.pem
</code></pre> <p>生成pfx</p> <pre><code>openssl pkcs12 -in root.pem -export -out root.pfx
</code></pre> <h3>需求3：从第三方vendor获得的证书导出公钥</h3> <p>从vendor获得vendor.cer.pem</p> <p>从pem格式的证书中导出pem格式的公钥</p> <pre><code>openssl x509 -inform PEM -in vendor.cer.pem -outform PEM -pubkey -noout &gt; vendor.pub.key.pem
</code></pre> <h3>需求4：用第三方vendor的证书生成jks</h3> <p>从vendor获得vendor.cer.pem</p> <p>从pem证书生成jks</p> <pre><code>keytool -import -alias paygate_cert -keystore vendor.jks -storepass 111111 -trustcacerts -file vendor.cer.pem
</code></pre> <p>下面这步可选复制粘贴 <a href="http://www.cfca.com.cn/cda-cgi/clientcgi?action=caCertPem">http://www.cfca.com.cn/cda-cgi/clientcgi?action=caCertPem</a> 和 <a href="http://www.cfca.com.cn/cda-cgi/clientcgi?action=getCrossCerts">http://www.cfca.com.cn/cda-cgi/clientcgi?action=getCrossCerts</a> 的内容至相应的pem。</p> <p>然后，</p> <pre><code>keytool -import -alias cfca_rca -keystore vendor.jks -storepass 111111 -trustcacerts -file rca.pemkeytool -import -alias cfca_pca -keystore vendor.jks -storepass 111111 -trustcacerts -file pca.pemkeytool -import -alias cfca_oca -keystore vendor.jks -storepass 111111 -trustcacerts -file oca.pem
</code></pre> <h3>需求5：查看jks状态</h3> <pre><code>keytool -list -keystore vendor.jks -storepass 111111
</code></pre> <h3>需求6：查看证书编号、有效期等详细信息</h3> <pre><code>keytool -list -keystore vendor.jks -storepass 111111 -v -alias key_alias
</code></pre> <h3>需求7：证书格式转换</h3> <p>例：从PEM到DER</p> <pre><code>openssl x509 -inform PEM -in root.cer.pem -outform DER -pubkey -out root.cer.der
</code></pre> <h3>需求8：查看证书内部数据结构(ASN.1)</h3> <pre><code>cat root.cer.pem|openssl asn1parse -inform PEM -icat root.cer.der|openssl asn1parse -inform DER -i
</code></pre> <h3>需求9：RSA私钥签名、公钥验签、公钥加密、私钥解密</h3> <p>RSA加解密相关的操作，使用<code>openssl rsautl</code>命令。</p> <p>该命令的参数分为如下几个部分(我们不关心关于输入输出文件的参数，因为我们使用标准输入和输出)：</p> <table class=confluenceTable><tbody> <tr> <th class=confluenceTh> key文件 -inkey file </th> <th class=confluenceTh> key类型 [|-pubin|-certin] </th> <th class=confluenceTh> key格式 -keyform [PEM|DER] </th> <th class=confluenceTh> 操作 [-sign|-verify <br class=atl-forced-newline>|-encrypt|-decrypt] </th> <th class=confluenceTh> 填充格式 [-pkcs|-oaep <br class=atl-forced-newline>|-ssl|-raw] </th> <th class=confluenceTh> 输出格式 [|-hexdump|-asn1parse] </th> </tr> <tr> <td class=confluenceTd> 指定key的文件名 </td> <td class=confluenceTd> 默认: 私钥 </td> <td class=confluenceTd> PEM(默认): <br class=atl-forced-newline>即二进制格式经过base64之后 <br class=atl-forced-newline>加上形同----BEGIN PUBLIC KEY---- <br class=atl-forced-newline>的表征key类型的头和尾 </td> <td class=confluenceTd> -sign <br class=atl-forced-newline><br class=atl-forced-newline>私钥签名 <br class=atl-forced-newline>(签名只能使用-pkcs <br class=atl-forced-newline>和-raw这两种填充) </td> <td class=confluenceTd> -pkcs(默认)： <br class=atl-forced-newline>PKCS#1 v1.5 填充 <br class=atl-forced-newline><br class=atl-forced-newline> </td> <td class=confluenceTd> -hexdump： <br class=atl-forced-newline>16进制输出 <br class=atl-forced-newline><br class=atl-forced-newline> </td> </tr> <tr> <td class=confluenceTd> 可为私钥、公钥或证书 </td> <td class=confluenceTd> -pubin: 公钥 </td> <td class=confluenceTd> DER: <br class=atl-forced-newline>即ASN.1二进制格式， <br class=atl-forced-newline>可用openssl asn1parse <br class=atl-forced-newline>理解其内部数据结构 </td> <td class=confluenceTd> -verify <br class=atl-forced-newline><br class=atl-forced-newline>公钥验签 <br class=atl-forced-newline>(输出为被加签内容) </td> <td class=confluenceTd> -oaep： <br class=atl-forced-newline>PKCS#1 OAEP </td> <td class=confluenceTd> -ans1parse： <br class=atl-forced-newline>对于-verify的场合常用， <br class=atl-forced-newline>用于理解PKCS系列 <br class=atl-forced-newline>ASN.1格式的证书。 </td> </tr> <tr> <td class=confluenceTd> </td> <td class=confluenceTd> -certin: 证书 </td> <td class=confluenceTd> </td> <td class=confluenceTd> -encrypt <br class=atl-forced-newline><br class=atl-forced-newline>公钥加密 </td> <td class=confluenceTd> -ssl： <br class=atl-forced-newline>  <br class=atl-forced-newline>SSL v2 中使用的 <br class=atl-forced-newline>向后兼容填充 </td> <td class=confluenceTd> </td> </tr> <tr> <td class=confluenceTd> </td> <td class=confluenceTd> </td> <td class=confluenceTd> </td> <td class=confluenceTd> -decrypt <br class=atl-forced-newline><br class=atl-forced-newline>私钥解密 </td> <td class=confluenceTd> -raw： <br class=atl-forced-newline>  <br class=atl-forced-newline>不做任何填充 </td> <td class=confluenceTd> </td> </tr> </tbody></table> <p>其中<code>-sign</code>和<code>-verify</code>成对使用，<code>-encrypt</code>和<code>-decrypt</code>成对使用。</p> <h3>需求10：查看pfx的内部信息</h3> <pre><code>openssl pkcs12 -info -in root.pfx 
</code></pre> <p>输入密码之后，证书、私钥，均以PEM的格式打印出来，可以直接另存为对应的文件，相当于导出。</p> <h3>需求12：jks导出银行公钥</h3> <pre><code>keytool -export -alias cfca_pca -keystore cebmerchant.jks  -file cfca_pca.cer  -storepass 111111
</code></pre> <h3>需求13：如何对base64、hex、decimal和binary之间进行转换</h3> <h4>binary-&gt;base64</h4> <pre><code>echo -n $binary|openssl base64
</code></pre> <p>上面命令的缺点是，它会自动换行，可以手工拼接，也可以采用如下命令直接获得不自动换行的base64：</p> <pre><code>echo -n $binary|ruby -rbase64  -e '$stdin.binmode;$stdout.binmode;y = Base64.encode64($stdin.read); $stdout.write  y'
</code></pre> <h4>base64-&gt;binary</h4> <pre><code>echo -n $base64|openssl base64 -d
</code></pre> <p>上面命令的缺点是，它只接受有自动换行（每64个字符）的base64，可以手工换行，也可以采用如下命令直接解码：</p> <pre><code>echo -n $base64|ruby -rbase64  -e '$stdin.binmode;$stdout.binmode;y = Base64.decode64($stdin.read); $stdout.write  y'
</code></pre> <h4>binary-&gt;hex</h4> <pre><code>echo -n $binary|xxd -p -c 256
</code></pre> <h4>hex-&gt;binary</h4> <pre><code>echo -n $hex|xxd -p -r
</code></pre> <h4>decimal-&gt;hex</h4> <p>设decimal为10；</p> <pre><code>echo 'obase=16; 10'|bc
</code></pre> <h4>hex-&gt;decimal</h4> <p>设hex为 a；</p> <pre><code>echo 'ibase=16; A'|bc
</code></pre> <p>注意要大写</p> <h4>怎么做大小写转换？</h4> <pre><code>tr '[:lower:]' '[:upper:]'
</code></pre> <h3>需求13：如何用命令行模拟ssl双向连接</h3> <p>若用<code>openssl s_client</code></p> <pre><code>pstree -pa|grep -F "nc" -B 1|grep -F "12380" -B 1|grep -v grep|grep bash|awk -F"," '{print $2}'|xargs kill -9while true; do nc -l -p 12380 |openssl s_client -debug -msg -cert tc-cer.pem -key tc-pri.pem -quiet -connect 127.0.0.1:11443; done 
</code></pre> <p>若用<code>wget</code></p> <pre><code>wget --server-response   --timeout=10 --append-output=xxx.log --debug --header='Host: www.domain.com' --post-data='blah=blah' --post-file=FILE --no-check-certificate  --certificate=root.cer.pem --certificate-type=PEM --private-key=root.pri.pem --private-key-type=PEM https://127.0.0.1:443/
</code></pre> <p>若用<code>curl</code></p> <pre><code>curl --data "blah=blah"  --insecure --key root.pri.pem --key-type PEM --pass  PASS --cert root.cer.pem --cert-type PEM --max-time 10 --header "User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)" "http://domain/url"
</code></pre> <h2>参考文献</h2> <ul> <li>man</li> <li><a href="http://www.vanemery.com/Linux/Apache/openSSL.html">Useful OpenSSL Tricks</a></li> <li><a href="https://www.sslshopper.com/ssl-converter.html">ssl-converter</a></li> <li><a href="http://firefly.javaeye.com/blog/674208">SSL双向认证Java实现 - CertPath证书链</a></li> <li><a href="http://conshell.net/wiki/index.php/Keytool_to_OpenSSL_Conversion_tips">Keytool to OpenSSL Conversion tips</a></li> <li><a href="http://java.sun.com/j2se/1.4.2/docs/guide/security/CryptoSpec.html#AppA">JavaSE Crypto Spec</a></li> <li><a href="http://www.ibm.com/developerworks/cn/web/tutorials/wa-tomcat/section4.html">配置 Tomcat 和 Wireshark 来获取并解码 SSL 通信</a></li> <li><a href="http://wiki.wireshark.org/SSL">http://wiki.wireshark.org/SSL</a></li> <li><a href="http://www.ibm.com/developerworks/cn/web/tutorials/wa-tomcat/section4.html">http://www.ibm.com/developerworks/cn/web/tutorials/wa-tomcat/section4.html</a></li> </ul> <section class=meta> <p> <span class=author> <a href='/'>宋皿</a> </span> <span class=time> <time datetime='2011-06-11 00:00:00 +0800'> 2011-06-11 </time> </span> </p> <p> <span class=license> Published under <a href='http://creativecommons.org/licenses/by-nc-nd/3.0/' rel=license>(CC) BY-NC-ND</a> </span> <span class=tags> tagged with <a href='/tech/tags.html#tag-技巧'> 技巧 </a> </span> </p> </section> <div id=disqus_thread></div> <script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'utensil-at-github'; // required: replace example with your forum shortname
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script> <a class=dsq-brlink href='http://disqus.com'> comments powered by <span class=logo-disqus>Disqus</span> </a> </article> </div> </div> </div> <script src="/javascripts/jquery-1.7.1.js?1593163993"></script> <script src="/javascripts/highlight.pack.js?1593163993"></script> <script>
  hljs.initHighlightingOnLoad();
  // $(document).ready(function() {
  //   $('pre code').each(function(i, e) {hljs.highlightBlock(e)});
  // });
</script> <script>
  // (function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"===e.location.protocol?"https:":"http:")+'//cdn.mxpnl.com/libs/mixpanel-2.2.min.js';f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f);b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!== typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");for(g=0;g<i.length;g++)f(c,i[g]); b._i.push([a,e,d])};b.__SV=1.2}})(document,window.mixpanel||[]); mixpanel.init("eda89891866a7e90b6699df21e79ea61");
  // mixpanel.track("visit");
</script> </body> </html>